<!--头部信息-->
<include file="public/header" />
<title></title>
<link rel='stylesheet' type='text/css' href='__TMPL__/public/assets/whgcms/css/activityread.css'>
<style>

.time span:first-child {
    float: left;
    width: 42px;
    display: inline-block;
    text-align: left;
}


/*.time span:nth-child(2) {
    width: 190px;
    display: inline-block;
}*/
</style>
</head>

<body>
    <!--导航信息-->
    <include file="public/nav" />
    <div class="main clearfix">
        <div class="main-content clearfix">
            <div class="details f-left">
                <!--  <div id="activitytime">
                       <div id="list-time"></div>
                       <div id="btn"></div>
                   </div>
                   <div id="details">

                   </div> -->
                <!-- 活动详情模板start-->
                <!--   <script type="text/x-handlebars-template" id="content">
                      <ul class="number clearfix" style="margin-bottom:30px;">
                      <li style="margin-right: 9px;display: inline-block; ">
                      <img src="__TMPL__/public/assets/whgcms/images/activityread/time.png " alt=" " style="width: 14px;height: 13px;margin-right: 6px;margin-top: 1px; "">
                      <span>{{format_published_time}}
                      </span>
                      </li>
                      <li style="margin-right: 9px;display: inline-block; ">{{venue_name}}</li>
                  </ul>
                      <p>{{{content}}}</p>

                  </script>
                  活动详情模板end -->
            </div>
            <div style="width: 320px;" class="f-right">
                <div>
                    <h3 style="font-size:16px;color:#1C2438;line-height:24px;padding-left: 8px;border-left: 3px solid #2F343B;">热门推荐</h3>
                    <ul id="Hot">
                    </ul>
                </div>
                <!--<div style="margin-top: 50px;">-->
                    <!--<h3 style="font-size:16px;color:#1C2438;line-height:24px;padding-left: 8px;border-left: 3px solid #2F343B;margin-bottom: 3px;">相关阅读</h3>-->
                    <!--<ul id="read">-->
                    <!--</ul>-->
                <!--</div>-->
            </div>
        </div>
    </div>
    <!-- 底部信息-->
    <include file="public/footer" />
    <!-- <script src="__TMPL__/public/assets/whgcms/lib/jquery.min.js "></script> -->
    <!-- <script src="__TMPL__/public/assets/whgcms/lib/layui/layui.all.js "></script> -->
    <!-- <script src="__TMPL__/public/assets/whgcms/lib/handlebars-v4.0.11.js "></script> -->
    <script src="__TMPL__/public/assets/whgcms/js/activityread.js"></script>
    <!-- <script src="__TMPL__/public/assets/whgcms/js/template.js"></script> -->
    <script type="text/x-handlebars-template" id="activity-template">
        <div style="width: 790px;margin-bottom: 11px; padding-bottom: 30px;background-color: #fff;" class="clearfix">
            <div class="title" style="font-size: 24px;">{{title}}</div>
            <img src="{{thumb}}" alt=" " style="width: 450px;height: 253px; margin-right: 44px;" class="f-left">
            <div class="f-left" style="width: 296px;">
                {{#if need_baoming}}
                <div class="time"><img src="__TMPL__/public/assets/whgcms/images/activityread/baoming.png" alt=""><span>报名时间：</span><span>{{format_baoming_start_time}} ~ </span><span style="margin-left: 101px;">{{format_baoming_end_time}}</span>
                </div>
                <div class="time"><img src="__TMPL__/public/assets/whgcms/images/activityread/shijian.png" alt=""><span>活动时间：</span><span>{{format_start_time}} ~
                </span><br><span style="margin-left: 101px;">{{format_end_time}}</span>
                </div>
                {{/if}}
                <div class="time"><img src="__TMPL__/public/assets/whgcms/images/activityread/address.png" alt=""><span>地点：</span><span style="white-space: pre-wrap;">{{address}}</span></div>
                {{#if need_baoming}}
                <div class="time"><img src="__TMPL__/public/assets/whgcms/images/activityread/venue.png" alt=""><span>场馆名称：</span><span>{{venue_name}}</span></span>
                </div>
                <div class="time"><img src="__TMPL__/public/assets/whgcms/images/activityread/people.png" alt=""><span>报名人数：</span>{{cnum}} / {{max_num}}
                </div>
                {{/if}}
                {{#if need_baoming}}
                    {{#test this}}

                    {{/test}}
                {{/if}}
            </div>
        </div>
        <p>{{{content}}}</p>
    </script>
    <script type="text/x-handlebars-template" id="hot-template">
        {{#each list}}
        <li style="margin-top: 20px;">
            <a href="{{buildSecondUrl '/portal/activity/read?id=' id}}">
                <div class="bg100" style="background-image: url({{thumb}});background-repeat: no-repeat;background-size: cover;background-position: top center;width: 320px;height: 180px;position: relative;">
                    <div style="width:320px;height:40px; background:rgba(0,0,0,.5);position: absolute;left: 0;bottom: 0;">
                        <h3 class="ellipsis" style="font-size:14px;color:rgba(255,255,255,1);overflow: hidden;white-space: nowrap;line-height: 40px;margin: 0 15px;">{{title}}</h3>
                    </div>
                </div>
            </a>
        </li>
        {{/each}}
    </script>
    <script type="text/x-handlebars-template" id="read-template">
        {{#each this}}
        <li style="margin-top: 19px;">
            <a href="{{buildSecondUrl '/portal/activity/read?id=' id}}" style="display: inline-block;" class="clearfix">
                <span class="layui-badge-dot layui-bg-cyan f-left" style="width: 3px;height: 3px;margin-right: 10px;margin-top: 8px;display: inline-block;color: #2F343B;"></span>
                <span class="f-left ellipsis" style="display: inline-block;width: 307px;white-space: nowrap;overflow: hidden;color: #2F343B; font-size: 14px;">{{title}}</span>
            </a>
        </li>
        {{/each}}
    </script>
    <script>
        Handlebars.registerHelper("test", function(attr, options) {
            var timestamp = Date.parse(new Date()) / 1000;

            if(attr['need_baoming'] == 1 &&
                attr['baoming'] == 1
            )
                return "<button class=\"layui-btn expire\">已报名</button>";

            if(attr['need_baoming'] == 1 &&
                timestamp >= attr['baoming_start_time'] &&
                timestamp <= attr['baoming_end_time'] &&
                attr['cnum'] != attr['max_num']
            )
                return "<button class=\"layui-btn enroll activity-active\" id=\"enroll\">报名</button>";

            if(attr['need_baoming'] == 1 &&
                timestamp >= attr['baoming_start_time'] &&
                timestamp <= attr['baoming_end_time'] &&
                attr['cnum'] == attr['max_num']
            )
                return "<button class=\"layui-btn enroll expire\" id=\"enroll\">已订满</button>";


            if(attr['need_baoming'] == 1 &&
                attr['baoming_start_time'] >= timestamp &&
                attr['baoming_end_time'] >= timestamp
            )
                return "<button class=\"layui-btn expire\">未开始</button>";

            if(attr['need_baoming'] == 1 &&
                attr['baoming_start_time'] <= timestamp &&
                attr['baoming_end_time'] <= timestamp
            )
                return "<button class=\"layui-btn expire\">已过期</button>";

        });
    $(function() {
        //导航选中
        selectNav(16);
        //获取活动详情
        var activity_id = {$Request.get.id};
        activity_detail(activity_id);
        //活动预约





        $(".enroll").click(function() {
            if (!$(".enroll").hasClass('yibaoming')) {
                enroll(activity_id);
            }
        })
    })

    //活动详情
    function activity_detail(activity_id) {
        request({
            url: '/api/activity/read',
            type: 'post',
            dataType: 'json',
            data: { 'id': activity_id },
            async: false,
            success: function(result) {
                if (result.status == 1) {

                    Handlebars.registerHelper("compare", function(start_time, end_time, options) {
                        var timestamp = Date.parse(new Date()) / 1000;
                        // console.log(start_time);
                        // console.log(end_time);
                        // console.log(timestamp);
                        if (timestamp >= start_time && timestamp <= end_time) {
                            return options.fn(this);
                        } else {
                            return options.inverse(this);
                        }
                    });

                    Handlebars.registerHelper("compare_num",function(apply_people_count,max_num, options){
                        if(apply_people_count == max_num ) {
                            return options.fn(this);
                        } else  {
                            return options.inverse(this);
                        }
                    });
                    var template = Handlebars.compile($("#activity-template").html());
                    $(".details").html(template(result.data));
                    $('title').html(result.data.title);
                }
            }
        }, true);

    }

    //活动预约
    function enroll(activity_id) {
        request({
            url: '/api/activity/enroll',
            type: 'post',
            dataType: 'json',
            data: { 'id': activity_id },
            success: function(result) {
                if (result.status == 1) {
                    // $('.layui-btn').css('background-color', '#acacac');
                    // $('.layui-btn').addClass('yibaoming');
                    $('.layui-btn').text('已报名');
                    $('.layui-btn').removeClass('activity-active');
                    $('.layui-btn').addClass('expire');
                    $('.layui-btn').unbind('click');
                    getdialog(result.msg,undefined,function(){
                        window.location.reload()
                    });

                } else {
                    var regex = /^1000[4-9]$/;
                    if (regex.test(result.code)) {
                        getdialog('未登录，请先登录且实名认证后方可报名！', '/portal/login/login/');
                    } else {
                        if (result.code == 13003) {
                            //已报名
                            // $('.layui-btn').css('background-color', '#acacac');
                            // $('.layui-btn').addClass('yibaoming');
                            getdialog(result.msg);
                        } else if (result.code == 13004) {
                            //未认证
                            getdialog(result.msg, '/portal/my/index?qurenzheng');
                        } else if (result.code == 13005) {
                            //人数已满
                            $('.layui-btn').css('background-color', '#acacac');
                            $('.layui-btn').addClass('yibaoming');
                            getdialog(result.msg);
                        } else {
                            getdialog(result.msg);
                        }
                    }
                }
            }
        }, true)
    }
    //相关推荐
        $.ajax({
            url:'/api/activity/index',
            data:{order:'published_time', page:1, len:3},
            dataType:'json',
            success:function(res){
                if(res.status == 1){
                    var hotTpl = $("#hot-template").html();
                    var hotCmp = Handlebars.compile(hotTpl);
                    var hotFun = hotCmp(res.data);
                    $('#Hot').html(hotFun);
                }
            }
        })
    </script>
</body>

</html>
